---
title: "Tree growth, mortality, and climatic stress in west-coast states, USA"
author:
  - name: "Jeremiah D. Groom"
    affiliations:
      - name: "Groom Analytics LLC"
        address: "1975 SE Crystal Lake Dr., Unit 173"
        city: "Corvallis"
        state: "OR"
        postal-code: "97333"
    orcid: "0000-0002-0110-1036"
    email: "jeremy@groomanalytics.com"
  - name: "Bryce Frank"
    affiliations:
      - name: "USDA Forest Service"
        department: "Pacific Northwest Field Station"
        address: "3625 93rd Ave SW"
        city: "Olympia"
        state: "WA"
        postal-code: "98512"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  officedown::rdocx_document:
    reference_docx: "template_use2.docx"
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center"
)

library(kableExtra)   # Enhanced table formatting
library(scales)       # Scale functions for visualization
library(flextable)    # Professional tables for Word output
library(officedown)
library(officer)
library(rvg)
#devtools::install_github("adletaw/captioner")
library(captioner) # For figure captions.

```


```{r other_settings}
fp <- fp_par(
  text.align = "center", 
  padding.bottom = 20, padding.top = 120, 
  border.bottom = fp_border())

ft <- fp_text(shading.color='#EFEFEF', bold = TRUE)
```


```{r constants}

source("Global.R")
source(paste0(CODE.LOC, "Functions.R"))

# Define any custom functions
format_p_value <- function(p) {
  case_when(
    p < 0.001 ~ "< 0.001",
    p < 0.01 ~ sprintf("= %.3f", p),
    TRUE ~ sprintf("= %.2f", p)
  )
}


set_flextable_defaults(
  font.family = "Times New Roman",
  font.size = 11,
  theme_fun = "theme_vanilla"
)

centeredP <- fp_par(text.align = "center")

```

```{r load-data}
# Some general analysis info + plots
analysis.stats <- read_rds(paste0(RESULTS.OTHER, "analysis.stats.RDS"))

# Percent of plots sampled with REMPER = 9, 10, and 11 years (rounded)
pct.remeas <- as.vector(analysis.stats$pct.remeas)

# Species scientific names
spp.names.use <- analysis.stats$gym.angio.dat

# Growth data for species overall, states, differences
grow.state <- read_csv(paste0(RESULTS1.LOC, "Growth_figs_", CLIM.VAR.USE, "/State_Growth_", CLIM.VAR.USE, ".csv"))
grow.all <- read_csv(paste0(RESULTS1.LOC, "Growth_figs_", CLIM.VAR.USE, "/All_Growth_", CLIM.VAR.USE, ".csv"))
grow.diff <- read_rds(paste0(save.loc.fcn(1), "Processed_6Domain_Data.RDS"))

# Mortality data for species overall and states
mort.state <- read_csv(paste0(RESULTS1.LOC, "Mort_figs_", CLIM.VAR.USE, "/State_Mortality_", CLIM.VAR.USE, ".csv"))
mort.all <- read_csv(paste0(RESULTS1.LOC, "Mort_figs_", CLIM.VAR.USE, "/All_Mortality_", CLIM.VAR.USE, ".csv"))
mort.diff <- read_rds(paste0(save.loc.fcn(2), "Processed_6Domain_Data.RDS"))


# Significant findings, Growth
grow.n <- nrow(grow.diff$AvB2)

grow.AvB.sig <- length(grow.diff$AvB2$significant[grow.diff$AvB2$significant == TRUE])
grow.AvB.signeg <- length(grow.diff$AvB2$significant[grow.diff$AvB2$significant == TRUE & grow.diff$AvB2$Means < 0])
grow.A.sig <- length(grow.diff$A_LMH2$significant[grow.diff$A_LMH2$significant == TRUE])
grow.A.signeg <- length(grow.diff$A_LMH2$significant[grow.diff$A_LMH2$significant == TRUE & grow.diff$A_LMH2$Means < 0])
grow.B.sig <- length(grow.diff$B_LMH2$significant[grow.diff$B_LMH2$significant == TRUE])
grow.B.signeg <- length(grow.diff$B_LMH2$significant[grow.diff$B_LMH2$significant == TRUE & grow.diff$B_LMH2$Means < 0])


# Significant findings, Mort
mort.AvB.sig <- length(mort.diff$AvB2$significant[mort.diff$AvB2$significant == TRUE])
mort.AvB.signeg <- length(mort.diff$AvB2$significant[mort.diff$AvB2$significant == TRUE & mort.diff$AvB2$Means < 0])
mort.A.sig <- length(mort.diff$A_LMH2$significant[mort.diff$A_LMH2$significant == TRUE])
mort.A.signeg <- length(mort.diff$A_LMH2$significant[mort.diff$A_LMH2$significant == TRUE & mort.diff$A_LMH2$Means < 0])
mort.B.sig <- length(mort.diff$B_LMH2$significant[mort.diff$B_LMH2$significant == TRUE])
mort.B.signeg <- length(mort.diff$B_LMH2$significant[mort.diff$B_LMH2$significant == TRUE & mort.diff$B_LMH2$Means < 0])

```

```{r table-creation}
# State growth
s.g.dat <- state.table.fcn(grow.state, grow.all, 1)

growth.ft <- flextable(s.g.dat) %>%
  fontsize(size = 9, part = "body") %>%
  fontsize(size = 10, part = "header") %>%
    italic(j = 1, part = "body") %>%
  line_spacing(i = NULL, j = NULL, space = 0.5, part = "body") %>% # Control space between lines. 
  theme_zebra(
    odd_header = "#FFFFFF",   # White background for all
    even_header = "#FFFFFF",
    odd_body = "#FFFFFF",     
    even_body = "#FFFFFF"     
  ) %>%
  set_table_properties(layout = "autofit", width = 0) 
  
max.grow.spp <- maxmin.fcn(grow.all, "Means", "LCI.95", "UCI.95", extreme = "max", cm2 = TRUE)
min.grow.spp <- maxmin.fcn(grow.all, "Means", "LCI.95", "UCI.95", extreme = "min", cm2 = TRUE)


# State mortality
s.m.dat <- state.table.fcn(mort.state, mort.all, 2)

mort.ft <- flextable(s.m.dat) %>%
  fontsize(size = 9, part = "body") %>%
  fontsize(size = 10, part = "header") %>%
  italic(j = 1, part = "body") %>%
  line_spacing(i = NULL, j = NULL, space = 0.5, part = "body") %>% # Control space between lines. 
  theme_zebra(
    odd_header = "#FFFFFF",   # White background for all
    even_header = "#FFFFFF",  
    odd_body = "#FFFFFF",     
    even_body = "#FFFFFF"     
  ) %>%
  set_table_properties(layout = "autofit", width = 0) 

max.mort.spp <- maxmin.fcn(mort.all, "Means", "LCI.95", "UCI.95", extreme = "max", cm2 = FALSE, digits = 2)
min.mort.spp <- maxmin.fcn(mort.all, "Means", "LCI.95", "UCI.95", extreme = "min", cm2 = FALSE, digits = 2)


# CWD amounts
min.mean.init <- analysis.stats$init.cwd.stats$Mean[analysis.stats$init.cwd.min.mean]
min.mean.init.spp <- analysis.stats$init.cwd.stats$Species[analysis.stats$init.cwd.min.mean]
max.mean.init <- analysis.stats$init.cwd.stats$Mean[analysis.stats$init.cwd.max.mean]
max.mean.init.spp <- analysis.stats$init.cwd.stats$Species[analysis.stats$init.cwd.max.mean]

max.q95.diff <- analysis.stats$diff.cwd.stats$q95[analysis.stats$diff.cwd.95max]
max.q95.diff.spp <- analysis.stats$diff.cwd.stats$Species[analysis.stats$diff.cwd.95max]
max.range.diff <- analysis.stats$diff.cwd.90range.max
max.q95.diff.spp <- analysis.stats$diff.cwd.stats$Species[analysis.stats$diff.cwd.95max]

```


```{r set_captions}

# 
fig_nums <- captioner::captioner(prefix = "Figure")
tab_nums <- captioner::captioner(prefix = "Table")


f.ref <- function(x) {
 stringr::str_extract(fig_nums(x), "[^:]*")
}

t.ref <- function(x)  {
  stringr::str_extract(tab_nums(x), "[^:]*")
}

tab.tbl_growth <- tab_nums(name = "tbl_growth", 
                        caption = "Decadal growth estimates by state and overall for analysis species. Mean estimates with confidence intervals and plot number are provided. Estimates are not made for states with fewer than 10 plots.")

tab.tbl_mort <- tab_nums(name = "tbl_mort", 
                        caption = "Decadal mortality estimates by state and overall for analysis species. Mean estimates with confidence intervals and plot number are provided. Estimates are not made for states with fewer than 10 plots.")

fig.cwdmap_cap <- fig_nums(name = "fig_cwdmap", 
                        caption = "Fuzzed FIA plot locations displayed with initial visit climatic water deficit (CWD) values (A) and CWD change between visits (C) for the U.S. states, north to south, of Washington, Oregon, and California (see inset map B for the location of these states within the USA).")

fig.domains <- fig_nums(name = "fig_domains",
                        caption = "Decadal (A) growth and (B) mortality domain estimates for *Abies lasiocarpa*.  The six domains are defined as FIA plots that fall [A]bove or [B]elow the CWD change threshold with [L]ow, [M]edium, or [H]igh initial CWD values (see text for details). E.g., 'AL' is Above CWD change threshold, Low initial CWD value. The distribution of plot CWD change and initial values (C) is presented as well, with the blue horizontal line at a change in CWD of 5 mm representing the change threshold and the green vertical lines representing the quantile boundaries between Low, Medium, and High initial CWD values." )

fig.diff_grow <- fig_nums(name = "fig_diffgrow", 
                          caption = paste0("Differences in mean growth rates (cm\u00B2/decade) between domains by species.  Domain abbreviations are described in the legend for ",
                                           f.ref("fig_domains"), 
                                           ". See each column legend for the key of domain differences.  Mean domain differences (circles) with 95% CIs (bars) that do not intersect zero are filled. Species above the dashed line are coniferous; those below are deciduous."))

fig.diff_mort <- fig_nums(name = "fig_diffmort", 
                          caption = paste0("Differences in mean decadal mortality rates between domains by species.  Domain abbreviations are described in the legend for ",
                                           f.ref("fig_domains"), 
                                           ". See each column legend for the key of domain differences.  Mean domain differences (circles) with 95% CIs (bars) that do not intersect zero are filled. Species above the dashed line are coniferous; those below are deciduous."))


```


# Abstract

# Introduction

# Methods  

## FIA data  

We used U.S. National Forest Inventory datasets for our analyses of forestland in California, Oregon, and Washington, USA.  Forestland is defined as an area of 4,050 m$^2$ that is at least 10 percent stocked or potentially stocked with tree species, excluding urban and agricultural land uses (Reams et al., 2005).  Additionally, as our study relied on plot revisit data, we only examined plots that were considered forestland during both visits.  

FIA plots consist of four points where all trees with stem diameters greater than or equal to 12.7 cm (for most species measured at 1.37 m above the ground) were tallied in a 7.32 m radius circular subplot (total area 672.5 m$^2$) with additional trees sampled in an anulus around each subplot (macroplot) around each subplot, with a total radius of 18 m from the center point and a total area of 1012 m$^2$.  We did not include data from FIA microplots.  Bechtold and Scott (2005) provide plot design details and measurement protocols.   

Since 2000, FIA plots have been selected via a spatially balanced probability sample (McRoberts 2005, Reams et al., 2005) with a target plot density of one ground plot every 24 km$^2$. Some regions and ownerships intensify the plot density; we excluded these additional plots to simplify stratification estimation, relying on FIA-defined strata and using the density of FIA Phase 1 sampling points within and across strata to determine strata weights.     

Plots in the three states are sampled every 10 years with a target of 1/10 of plots sampled in a panel every year (Thompson 2015). Our analysis depends on examining the fate and growth of trees from two sequential visits (referred to as the first and second plot visit), ideally from a complete sample panel remeasure.  We obtained our FIA data from the USDA FIA DataMart web portal (https://research.fs.usda.gov/products/dataandtools/fia-datamart; downloaded May 5, 2025).  They included plot data sampled from 2001 to 2023. 

Individual trees within plots were retained in the analysis if they were alive at the initial visit and met the stem diameter criterion during that visit (i.e., plot ingrowth was not included).  The growth analysis additionally restricted trees considered to those that were alive at both visits.  The mortality analysis excluded trees killed through silvicultural practices.  Both analyses excluded trees that shrank in diameter, physically moved due to landslides or other event, were erroneously tallied at either visit, were missed due to data collection procedural changes, or existed at any time in a nonsampled area.  We used only FIA plots sampled specifically for tree mortality and growth.    

## Climate data

We obtained plot-level CWD data from ClimateNA (Wang et al. 2016) for June, July, and August (summer months) between 1980 and 2023 (Bryce: I just averaged the CWD values for these months.  It wasn’t available seasonally, was it? Also, can you provide more info on how CWD is calculated?  I know it is PET-AET, but I’m not sure how to interpret a monthly/seasonal value). Latitude and longitude were based on FIA-fuzzed coordinates (citation?  Bryce – should we tighten this up by running the analysis on non-fuzzed coordinates?).  We found the 20-year mean of summer CWD values for each plot prior to and including the first visit.  We refer this this value as the “initial CWD value”. We then found the mean of summer CWD values between visits and including the second visit year.  The difference between this second value and initial CWD value is the “CWD change value” (maybe ‘difference’ really is a better, less loaded term).  Both the initial CWD and CWD change values are mapped in Figure 1.  

## Analysis
Estimation approach: Following Section 4.3.4 in Scott et al. (2005) we obtained point estimates of species growth and mortality using a ratio estimators (Eqn 4.16).  For mortality, the numerator is the sum of stratum-weighted means of trees per plot of a given species that died in plots.  The number of sampled trees in each plot is expanded by the area sampled (subplot or macroplot area) adjusted by the proportion of the plot area available for sampling and the number of years between visits.    The denominator is similar but is calculated as the sum of stratum-weighted means of all trees per plot of a given species.    

The numerator of species-specific growth estimates is the sum of stratum-weighted means of the increase in basal area (cm$^2$) per plot while the denominator is the same as was used for the mortality estimate. This produces a point estimate for a species’ mean growth.  Mortality and growth values were standardized to a decadal period.  

The analysis finds species growth and mortality estimates for six domains based on CWD values (Figure 2C).   The initial CWD values are divided into three quantiles: values below the first quartile (Low), between the first and third quartiles (Medium), and above the third quartile (High).  These initial CWD value divisions allowed for species-specific assessments.  For all species we defined an arbitrary boundary of 5 mm to define plots with a greater change in CWD (Above [the boundary]) and those with less CWD change (Below).  This was done because species did not differ greatly in CWD change (Table S2).  The category Below includes CWD changes that are negative (i.e., mean CWD was larger prior to the initial visit than between visits).  We also report species mortality and growth estimates for all plots across and within Oregon, Washington, and California irrespective of CWD values.  We limited the number of species examined to those with more than 400 plots.  We report domain estimates for all CWD-based domains with 10 or more plots.    

We obtained empirical means and 95% confidence intervals via bootstrap. For every species we sampled plots with replacement from within each of the strata and obtained point estimates.  For each domain we calculated a mean and upper and lower 95% CIs with the 2.5% and 97.5% quantiles from 1000 sampling iterations.  This approach allows for nonsymmetrical CIs around a mean and prevents CIs from including negative values.  We estimated differences between pairs of CWD domains by subtracting within-iteration domain point estimates.    
[permutation analysis]



# Results

Our study tracked the fate of `r comma(analysis.stats$tree.num)` trees from `r length(sel.spp)` species in `r comma(analysis.stats$plot.num)` plots that were visited twice by FIA crews. The two visits for `r pct.remeas[2]`% of plots were 10 years apart (`r pct.remeas[1]`% were 9 years, `r pct.remeas[3]`% were 11 years). Plots were distributed in `r analysis.stats$strat.num` strata.  Of the `r length(sel.spp)` species, `r analysis.stats$n.gym.spp` are gymnosperms.  Mean overall growth rates for species varied between `r min.grow.spp$mean` (*`r min.grow.spp$spp`*) and `r max.grow.spp$mean` (*`r max.grow.spp$spp`*, `r t.ref("tbl_growth")`) cm$^2$/decade.  Decadal mean mortality rates varied between `r min.mort.spp$mean` (*`r min.mort.spp$spp`*) and `r max.mort.spp$mean` (*`r max.mort.spp$spp`*, `r t.ref("tbl_mort")`). Growth and mortality rates differed among states (Tables `r tab_nums("tbl_growth", display = "num")` and `r tab_nums("tbl_mort", display = "num")`).

Forested plot 10-year differences in CWD do not visually coincide with initial CWD values (Figure `r fig_nums("fig_cwdmap", display = "num")`); however, `r analysis.stats$cwd.gt0.pct`% of plots increased in their CWD values to some degree during that time period. Tree species exhibited a variety of initial-visit CWD ranges, with means ranging from `r min.mean.init` (*`r min.mean.init.spp`*) to `r max.mean.init` (*`r max.mean.init.spp`*; Table S1).  The CWD difference tended to be comparatively small, with a maximum 95th percentile value of `r max.q95.diff` (*`r max.q95.diff.spp`*, Table S2). The distribution of individual species plot domain values for CWD and change in CWD can be explored on the dashboard(). 

The confidence intervals for 10-year mortality and growth rate domains did not necessarily follow the same patterns nor did all confidence intervals for a species' mortality or growth estimates overlap (e.g., Figures `r fig_nums("fig_domains", display = "num")`A and `r fig_nums("fig_domains", display = "num")`B). The relationship between initial CWD values and plot-level change in CWD were not reliably linear (e.g., Figure `r fig_nums("fig_domains", display = "num")`C) and varied by species (see dashboard).    

We examined differences in 10-year growth estimates among domains (Figure `r fig_nums("fig_diffgrow", display = "num")`).  The column "Above vs. Below Threshold" compares the domains above the CWD change threshold with those below it (e.g., for *Abies lasiocarpa*, subtracting the estimates for columns BL, BM, and BH from AL, AM, AH, respectively; Figure `r fig_nums("fig_domains", display = "num")`A).  There were `r grow.AvB.sig` estimates out of `r grow.n` which had 95% CIs that did not overlap with zero; `r grow.AvB.signeg` of these were negative. Negative estimates indicate that the growth rate was greater for a species in plots below the change estimates.   

The second column of Figure `r fig_nums("fig_diffgrow", display = "num")` shows the differences in growth estimates AH - AL, AH - AM, and AM - AL for each species; effectively, the top row of domains shown in Figure `r fig_nums("fig_domains", display = "num")`A.  `r grow.A.sig` comparisons had 95% CIs that did not include 0, of which `r grow.A.signeg` were negative.  Negative values indicate that a lower-valued initial CWD domain had a greater growth rate than a higher-valued domain.  The third column displays the same domain differences but for the bottom row of domains shown in `r fig_nums("fig_domains", display = "num")`A.  `r grow.B.sig` comparisons had 95% CIs that did not include 0, of which `r grow.B.signeg` were negative. Like the second column, negative differences indicate lower initial-value CWD domains had higher growth than higher domains.  

We examined mortality estimates in a similar fashion.  The first column in Figure `r fig_nums("fig_diffmort", display = "num")` has `r mort.AvB.sig` comparisons with 95% CIs that do not overlap zero, `r mort.AvB.sig - mort.AvB.signeg` of which are positive, indicating mortality is greater for those species in one or more of the above-threshold CWD change domains.  The middle column had `r mort.A.sig` "significant" comparisons, `r mort.A.signeg` of which were negative (for the above-threshold change CWD domains, there was more mortality for lower initial-value CWD domains).  The right column had `r mort.B.sig` "significant" comparisons, `r mort.B.signeg` of which were negative (for the below-threshold change CWD domains, there was more mortality for lower initial-value CWD domains).   




# Discussion

The initial CWD values coincide fairly well with mean annual precipitation [NOAA Climate.gov](https://www.climate.gov/news-features/featured-images/new-maps-annual-average-temperature-and-precipitation-us-climate). 

# Conclusion

# Acknowledgments

# References

::: {#refs}
Wang, T., Hamann, A. Spittlehouse, D.L. and Carroll, C. 2016. Locally downscaled and spatially customizable climate data for historical and future periods for North America. PLoS One 11: e0156720

:::




<!---BLOCK_LANDSCAPE_START--->



```{r tbl-growth, tab.cap=tab.tbl_growth}

growth.ft 

```


```{r tbl-mort, tab.cap = tab.tbl_mort}

mort.ft 

```

<!---BLOCK_LANDSCAPE_STOP--->



```{r mapfig, fig.height = 7,  fig.dpi=300, fig.cap=fig.cwdmap_cap, fig.cap.pre="", fig.cap.sep=""}

# Output from Manuscript_information.R
knitr::include_graphics(paste0(RESULTS.OTHER, "cwd_maps_figure.png"))

```


```{r domainsfig, fig.width = 6,  fig.dpi=300, fig.cap=fig.domains, fig.cap.pre="", fig.cap.sep=""}

# Output from Manuscript_information.R
knitr::include_graphics(paste0(RESULTS.OTHER, "Example_spp_figure.png"))

```


```{r diff_grow_fig, fig.height = 6, width = 6, fig.dpi=300, fig.cap=fig.diff_grow, fig.cap.pre="", fig.cap.sep=""}

# Output from Manuscript_information.R
knitr::include_graphics(paste0(RESULTS1.LOC, "/Growth_figs_cwd/Growth_Panel_Plot.png"))

```


```{r diff_mort_fig, fig.height = 6, width = 6, fig.dpi=300, fig.cap=fig.diff_mort, fig.cap.pre="", fig.cap.sep=""}

# Output from Manuscript_information.R
knitr::include_graphics(paste0(RESULTS1.LOC, "/Mort_figs_cwd/Mort_Panel_Plot.png"))

```


